FROM node:20.18.0-slim AS base

WORKDIR /app

ENV NEXT_TELEMETRY_DISABLED=1 \
    TURBO_TELEMETRY_DISABLED=1 \
    PNPM_HOME="/pnpm" \
    PATH="/pnpm:$PATH"

RUN npm install -g corepack@0.31.0 && \
    corepack enable

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./

RUN PNPM_VERSION=$(node -p "require('./package.json').packageManager.split('@')[1]") && \
    corepack prepare "pnpm@${PNPM_VERSION}" --activate


FROM base AS builder

ENV NODE_OPTIONS="--max_old_space_size=4096"

# Copy package.json files first (changes less frequently than source)
COPY oss/package.json ./oss/package.json
COPY --parents packages/*/package.json ./

RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

# Copy source code last (changes more frequently)
COPY packages/ ./packages/
COPY oss/ ./oss/

RUN --mount=type=cache,id=nextjs-oss,target=/app/oss/.next/cache \
    pnpm turbo run build --filter=@agenta/oss


FROM node:20.18.0-slim AS runner

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=0.0.0

WORKDIR /app

ENV NEXT_TELEMETRY_DISABLED=1 \
    NODE_ENV=production

COPY --from=builder /app/oss/.next/standalone /app
COPY --from=builder /app/oss/.next/static /app/oss/.next/static
COPY --from=builder /app/oss/public /app/oss/public
COPY ./entrypoint.sh /app/entrypoint.sh

LABEL org.opencontainers.image.title="agenta-web" \
    org.opencontainers.image.description="Agenta Web OSS GH runtime image" \
    org.opencontainers.image.version="${VERSION}" \
    org.opencontainers.image.revision="${VCS_REF}" \
    org.opencontainers.image.created="${BUILD_DATE}"

ENTRYPOINT ["/app/entrypoint.sh"]
EXPOSE 3000
