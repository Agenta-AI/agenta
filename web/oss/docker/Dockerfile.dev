FROM node:20.18-slim

ENV TURBO_TELEMETRY_DISABLED=1

WORKDIR /app

# Install jq for JSON parsing
RUN apt-get update && apt-get install -y jq
    
# Install dependencies based on the preferred package manager
COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* .npmrc* ./
COPY ./entrypoint.sh /app/entrypoint.sh   

# Extract PNPM version and install it
RUN PNPM_VERSION=$(cat package.json | jq -r '.packageManager | split("@")[1]') && \
    npm install -g pnpm@${PNPM_VERSION}

# Copy app package manifests
COPY oss/package.json ./oss/yarn.lock* ./oss/package-lock.json* ./oss/pnpm-lock.yaml* ./oss/.npmrc* ./oss/

# Copy workspace package manifests (required for workspace:* resolution)
COPY packages/agenta-shared/package.json ./packages/agenta-shared/
COPY packages/agenta-ui/package.json ./packages/agenta-ui/
COPY packages/agenta-entities/package.json ./packages/agenta-entities/
COPY packages/agenta-entity-ui/package.json ./packages/agenta-entity-ui/
COPY packages/agenta-playground/package.json ./packages/agenta-playground/
COPY packages/agenta-playground-ui/package.json ./packages/agenta-playground-ui/

# Copy shared package config files (required by package tsconfigs)
COPY packages/tsconfig.base.json ./packages/
COPY packages/css-modules.d.ts ./packages/

# Copy tests workspace manifest (OSS depends on @agenta/web-tests)
COPY tests/package.json ./tests/

COPY ./pnpm-workspace.yaml ./turbo.json ./
RUN pnpm i

COPY tsconfig.json .

# Copy workspace package sources (after install to preserve layer caching)
COPY packages/agenta-shared/src ./packages/agenta-shared/src
COPY packages/agenta-shared/tsconfig.json ./packages/agenta-shared/
COPY packages/agenta-ui/src ./packages/agenta-ui/src
COPY packages/agenta-ui/tsconfig.json ./packages/agenta-ui/
COPY packages/agenta-entities/src ./packages/agenta-entities/src
COPY packages/agenta-entities/tsconfig.json ./packages/agenta-entities/
COPY packages/agenta-entity-ui/src ./packages/agenta-entity-ui/src
COPY packages/agenta-entity-ui/tsconfig.json ./packages/agenta-entity-ui/
COPY packages/agenta-playground/src ./packages/agenta-playground/src
COPY packages/agenta-playground/tsconfig.json ./packages/agenta-playground/
COPY packages/agenta-playground-ui/src ./packages/agenta-playground-ui/src
COPY packages/agenta-playground-ui/tsconfig.json ./packages/agenta-playground-ui/

COPY oss/src ./oss/src
COPY oss/public ./oss/public
COPY oss/tsconfig.json ./oss

COPY oss/postcss.config.mjs ./oss/postcss.config.mjs

COPY oss/next.config.ts ./oss/next.config.ts

COPY oss/tailwind.config.ts ./oss/tailwind.config.ts

ENTRYPOINT ["./entrypoint.sh"]
EXPOSE 3000
