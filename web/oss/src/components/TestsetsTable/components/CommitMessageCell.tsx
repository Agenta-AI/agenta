import {memo, useEffect, useMemo} from "react"

import {Typography} from "antd"
import {useSetAtom} from "jotai"
import {LOW_PRIORITY, useAtomValueWithSchedule} from "jotai-scheduler"

import {
    latestRevisionStatefulAtomFamily,
    requestLatestRevisionAtom,
} from "@/oss/state/entities/testset"

interface CommitMessageCellProps {
    testsetId: string
    maxLines?: number
}

/**
 * Custom cell component that displays the commit message for a testset row.
 *
 * Uses the testset ID to read from the latestRevisionStatefulAtomFamily which provides
 * the latest revision's commit message via batched fetching for performance.
 *
 * Features:
 * - Uses LOW_PRIORITY scheduling to defer updates during scroll (prevents jank)
 * - Leverages batched API requests (multiple cells mounting = single batch request)
 * - Shows loading state while fetching
 * - Memoized for optimal re-render performance
 * - Stable atom reference prevents unnecessary re-subscriptions
 */
const CommitMessageCell = memo(function CommitMessageCell({
    testsetId,
    maxLines = 2,
}: CommitMessageCellProps) {
    const requestLatestRevision = useSetAtom(requestLatestRevisionAtom)

    // Create a stable atom reference for this testset
    const statefulAtom = useMemo(() => latestRevisionStatefulAtomFamily(testsetId), [testsetId])

    // Use LOW_PRIORITY scheduling to prevent scroll jank
    const {data: latestRevision, isPending} = useAtomValueWithSchedule(statefulAtom, {
        priority: LOW_PRIORITY,
    })

    // Request the latest revision on mount (batched automatically)
    useEffect(() => {
        if (testsetId) {
            requestLatestRevision(testsetId)
        }
    }, [testsetId, requestLatestRevision])

    const message = latestRevision?.message

    // Filter out auto-generated commit messages
    const isAutoGenerated = useMemo(() => {
        if (!message) return true
        return (
            message.startsWith("Updated testset:") ||
            message.startsWith("Patched testset") ||
            message.startsWith("Initial commit")
        )
    }, [message])

    console.log("latestRevision", message, isAutoGenerated)

    // Show loading state while fetching
    if (isPending) {
        return (
            <Typography.Text type="secondary" className="text-xs animate-pulse">
                Loading...
            </Typography.Text>
        )
    }

    // Show dash for empty or auto-generated messages
    if (!message || isAutoGenerated) {
        return (
            <Typography.Text type="secondary" className="text-xs">
                â€”
            </Typography.Text>
        )
    }

    // Render the commit message with ellipsis and tooltip
    return (
        <Typography.Text
            ellipsis={{rows: maxLines, tooltip: message}}
            className="text-gray-600"
            title={message}
        >
            {message}
        </Typography.Text>
    )
})

CommitMessageCell.displayName = "CommitMessageCell"

export default CommitMessageCell
