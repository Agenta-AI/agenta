###
# OIDC Authorization Tests (EE Only)
# Tests the OIDC authorization flow initiation
#
# Setup:
# 1. Ensure AGENTA_LICENSE=ee
# 2. Create organization with SSO provider:
#    - Add organization_providers record with OIDC config
#    - Configure issuer, client_id, client_secret
# 3. Update variables below with actual UUIDs
###

@baseUrl = http://localhost:8000
@contentType = application/json

# REPLACE THESE WITH ACTUAL VALUES FROM YOUR DATABASE
@organizationId = 00000000-0000-0000-0000-000000000000
@providerId = 00000000-0000-0000-0000-000000000000

### Test 1: Initiate OIDC Authorization (Valid Provider)
# Expected: 302 redirect to IdP authorization endpoint
# Should include state parameter and redirect_uri
GET {{baseUrl}}/auth/authorize/oidc?provider_id={{providerId}}&redirect=/
Accept: application/json

### Test 2: OIDC Authorization with Custom Redirect
# Expected: 302 redirect, redirect_uri includes custom path
GET {{baseUrl}}/auth/authorize/oidc?provider_id={{providerId}}&redirect=/dashboard
Accept: application/json

### Test 3: Invalid Provider ID (Not Found)
# Expected: 404 Not Found
GET {{baseUrl}}/auth/authorize/oidc?provider_id=99999999-9999-9999-9999-999999999999&redirect=/
Accept: application/json

### Test 4: Disabled Provider
# Prerequisites: Provider exists but enabled=false
# Expected: 403 Forbidden or 404
GET {{baseUrl}}/auth/authorize/oidc?provider_id={{providerId}}&redirect=/
Accept: application/json

### Test 5: Missing Provider ID
# Expected: 422 Validation error
GET {{baseUrl}}/auth/authorize/oidc?redirect=/
Accept: application/json

### Test 6: OIDC in OSS Mode (Should Fail)
# Prerequisites: AGENTA_LICENSE=oss
# Expected: 404 Not Found with message "SSO/OIDC is only available in Enterprise Edition"
GET {{baseUrl}}/auth/authorize/oidc?provider_id={{providerId}}&redirect=/
Accept: application/json

###
# OIDC Flow Overview:
# 1. User clicks SSO provider button
# 2. Frontend calls GET /auth/authorize/oidc?provider_id=xxx
# 3. Backend generates state, stores in state_store
# 4. Backend redirects (302) to IdP authorization endpoint
# 5. User authenticates at IdP
# 6. IdP redirects back to /auth/callback with code + state
# 7. Backend exchanges code for tokens
# 8. Backend creates/links user_identity
# 9. Backend creates session with identities array
# 10. Backend redirects to application
###

###
# Testing OIDC Provider Configuration:
# You can verify provider config is loaded correctly by checking:
# - Provider record exists in organization_providers table
# - Config JSONB contains: issuer, client_id, client_secret, scopes
# - Provider is enabled (enabled=true)
# - Organization exists and has policies configured
###

###
# Example Provider Configuration (organization_providers table):
# {
#   "id": "uuid",
#   "organization_id": "uuid",
#   "slug": "okta",
#   "name": "Okta SSO",
#   "enabled": true,
#   "config": {
#     "issuer": "https://dev-12345.okta.com",
#     "client_id": "0oa...",
#     "client_secret": "xxx",
#     "scopes": ["openid", "profile", "email"]
#   }
# }
###
