###
# Database Setup & Verification
# SQL commands to set up test data and verify schema
#
# Run these in psql or your database client BEFORE running other tests
###

###
# 1. Verify Migrations Applied
###

# Check user_identities table exists
# \d user_identities

# Expected columns:
# - id (uuid)
# - user_id (uuid, FK to users.id)
# - method (text)
# - subject (text)
# - domain (text, nullable)
# - created_at (timestamp)
# - updated_at (timestamp)
#
# Expected constraints:
# - UNIQUE (method, subject)
# - INDEX on (user_id, method)
# - INDEX on (domain)


###
# 2. Verify Organization Slug and Kind Columns Added
###

# Check organizations table has slug and kind columns
# \d organizations

# Expected:
# - slug column (text, unique, nullable)
# - kind column (text, NOT NULL, default 'collaborative')
# - CHECK constraint: kind IN ('personal', 'collaborative')
# - INDEX on kind


###
# 3. Setup Test Collaborative Organization (EE Mode)
###

-- Create test collaborative organization with slug
-- INSERT INTO organizations (id, name, slug, description, kind, owner, created_at, updated_at)
-- VALUES (
--   gen_random_uuid(),
--   'ACME Corporation',
--   'acme',
--   'Test collaborative organization for SSO',
--   'collaborative',
--   '<userId>',  -- Replace with actual user ID who will own this org
--   now(),
--   now()
-- )
-- RETURNING id;
-- Save the returned ID as @testOrgId


###
# 4. Setup Test Personal Organization (EE Mode)
###

-- Create test personal organization (for testing domain verification restrictions)
-- INSERT INTO organizations (id, name, slug, description, kind, owner, created_at, updated_at)
-- VALUES (
--   gen_random_uuid(),
--   'Personal',
--   NULL,  -- Personal orgs cannot have slugs
--   NULL,
--   'personal',
--   '<userId>',  -- Replace with actual user ID
--   now(),
--   now()
-- )
-- RETURNING id;
-- Save the returned ID as @testPersonalOrgId

-- Add user as member to their personal org
-- INSERT INTO organization_members (id, user_id, organization_id, role, created_at, updated_at)
-- VALUES (
--   gen_random_uuid(),
--   '<userId>',
--   '<testPersonalOrgId>',
--   'owner',
--   now(),
--   now()
-- );


###
# 5. Setup Organization Policy (EE Mode)
###

-- Allow SSO + auto-join for test collaborative organization
-- INSERT INTO organization_policies (
--   id,
--   organization_id,
--   allowed_methods,
--   invitation_only,
--   domains_only,
--   auto_join,
--   disable_root,
--   created_at,
--   updated_at
-- )
-- VALUES (
--   gen_random_uuid(),
--   '<testOrgId>',  -- Replace with actual org ID
--   ARRAY['sso:*'],  -- Only SSO allowed
--   false,  -- Not invitation only
--   true,   -- Enforce verified domains
--   true,   -- Auto-join users with verified domain emails
--   false,
--   now(),
--   now()
-- );


###
# 6. Setup Verified Domain (EE Mode - Collaborative Org)
###

-- Add verified domain for SSO on collaborative org
-- INSERT INTO organization_domains (
--   id,
--   organization_id,
--   domain,
--   verified,
--   verification_token,
--   created_at,
--   updated_at
-- )
-- VALUES (
--   gen_random_uuid(),
--   '<testOrgId>',  -- Collaborative org ID
--   'acme.com',
--   true,  -- Already verified
--   null,
--   now(),
--   now()
-- )
-- RETURNING id;
-- Save as @testDomainId


###
# 7. Test Domain Verification Restrictions (EE Mode)
###

-- Attempt to add domain to personal org (should fail at verification)
-- INSERT INTO organization_domains (
--   id,
--   organization_id,
--   domain,
--   verified,
--   verification_token,
--   created_at,
--   updated_at
-- )
-- VALUES (
--   gen_random_uuid(),
--   '<testPersonalOrgId>',  -- Personal org ID
--   'personal-test.com',
--   false,  -- Not verified yet
--   'test-token-123',
--   now(),
--   now()
-- )
-- RETURNING id;
-- Save as @personalOrgDomainId

-- NOTE: Attempting to verify this domain should fail with:
-- "Personal organizations cannot verify domains"


###
# 8. Test Domain Exclusivity (EE Mode)
###

-- Create second collaborative org to test exclusivity
-- INSERT INTO organizations (id, name, slug, description, kind, owner, created_at, updated_at)
-- VALUES (
--   gen_random_uuid(),
--   'Second Corp',
--   'second',
--   'Test domain exclusivity',
--   'collaborative',
--   '<userId>',
--   now(),
--   now()
-- )
-- RETURNING id;
-- Save as @secondOrgId

-- Attempt to verify same domain as first org
-- INSERT INTO organization_domains (
--   id,
--   organization_id,
--   domain,
--   verified,
--   verification_token,
--   created_at,
--   updated_at
-- )
-- VALUES (
--   gen_random_uuid(),
--   '<secondOrgId>',
--   'acme.com',  -- Same domain as testOrgId
--   false,
--   'conflict-token-456',
--   now(),
--   now()
-- )
-- RETURNING id;
-- Save as @conflictingDomainId

-- NOTE: Attempting to verify this domain should fail with:
-- "Domain 'acme.com' is already verified by another organization"


###
# 9. Setup OIDC Provider (EE Mode)
###

-- Add OIDC provider configuration
-- INSERT INTO organization_providers (
--   id,
--   organization_id,
--   slug,
--   name,
--   description,
--   enabled,
--   domain_id,
--   config,
--   created_at,
--   updated_at
-- )
-- VALUES (
--   gen_random_uuid(),
--   '<testOrgId>',
--   'okta',
--   'Okta SSO',
--   'ACME Okta integration',
--   true,
--   '<testDomainId>',
--   '{
--     "issuer": "https://dev-12345.okta.com",
--     "client_id": "0oa...",
--     "client_secret": "xxx",
--     "scopes": ["openid", "profile", "email"],
--     "authorization_endpoint": "https://dev-12345.okta.com/oauth2/v1/authorize",
--     "token_endpoint": "https://dev-12345.okta.com/oauth2/v1/token",
--     "userinfo_endpoint": "https://dev-12345.okta.com/oauth2/v1/userinfo"
--   }'::jsonb,
--   now(),
--   now()
-- )
-- RETURNING id;
-- Save as @testProviderId


###
# 10. Create Test User
###

-- Create test user
-- INSERT INTO users (id, uid, username, email, created_at, updated_at)
-- VALUES (
--   gen_random_uuid(),
--   'st_user_123',  -- SuperTokens user ID
--   'Test User',
--   'test@acme.com',
--   now(),
--   now()
-- )
-- RETURNING id;
-- Save as @testUserId


###
# 11. Add User to Organization (EE Mode)
###

-- Create organization membership
-- INSERT INTO organization_members (id, user_id, organization_id)
-- VALUES (
--   gen_random_uuid(),
--   '<testUserId>',
--   '<testOrgId>'
-- );


###
# 12. Verification Queries
###

-- Check all test data created successfully

-- Verify organizations (check kind column)
-- SELECT id, name, slug, kind FROM organizations ORDER BY kind;

-- Verify collaborative organization
-- SELECT id, name, slug, kind FROM organizations WHERE slug = 'acme';

-- Verify personal organization
-- SELECT id, name, slug, kind FROM organizations WHERE kind = 'personal';

-- Verify policy (check auto_join field)
-- SELECT allowed_methods, invitation_only, domains_only, auto_join
-- FROM organization_policies
-- WHERE organization_id = '<testOrgId>';

-- Verify domains
-- SELECT od.id, od.domain, od.verified, o.name as org_name, o.kind as org_kind
-- FROM organization_domains od
-- JOIN organizations o ON o.id = od.organization_id
-- ORDER BY o.kind, od.domain;

-- Verify provider
-- SELECT slug, name, enabled, config->>'issuer' as issuer
-- FROM organization_providers
-- WHERE organization_id = '<testOrgId>';

-- Verify user
-- SELECT id, email FROM users WHERE email = 'test@acme.com';

-- Verify membership
-- SELECT om.id, u.email, o.name, o.kind
-- FROM organization_members om
-- JOIN users u ON u.id = om.user_id
-- JOIN organizations o ON o.id = om.organization_id
-- WHERE u.email = 'test@acme.com'
-- ORDER BY o.kind;


###
# 13. Cleanup (Run after testing)
###

-- Clean up test data
-- DELETE FROM organization_members WHERE user_id = '<testUserId>';
-- DELETE FROM organization_providers WHERE organization_id IN ('<testOrgId>', '<secondOrgId>');
-- DELETE FROM organization_domains WHERE organization_id IN ('<testOrgId>', '<testPersonalOrgId>', '<secondOrgId>');
-- DELETE FROM organization_policies WHERE organization_id IN ('<testOrgId>', '<secondOrgId>');
-- DELETE FROM user_identities WHERE user_id = '<testUserId>';
-- DELETE FROM users WHERE id = '<testUserId>';
-- DELETE FROM organizations WHERE id IN ('<testOrgId>', '<testPersonalOrgId>', '<secondOrgId>');


###
# Quick Setup Script (OSS Mode - Email OTP Only)
###

-- For OSS mode testing, verify migrations:
-- SELECT EXISTS (
--   SELECT FROM information_schema.tables
--   WHERE table_name = 'user_identities'
-- ) as user_identities_exists;

-- SELECT EXISTS (
--   SELECT FROM information_schema.columns
--   WHERE table_name = 'organizations' AND column_name = 'slug'
-- ) as org_slug_exists;

-- SELECT EXISTS (
--   SELECT FROM information_schema.columns
--   WHERE table_name = 'organizations' AND column_name = 'kind'
-- ) as org_kind_exists;

-- Verify OSS has exactly 1 collaborative organization
-- SELECT COUNT(*) as org_count, kind
-- FROM organizations
-- GROUP BY kind;
-- Expected: 1 row with kind='collaborative', count=1

-- Verify no personal organizations exist in OSS
-- SELECT COUNT(*) as personal_org_count
-- FROM organizations
-- WHERE kind = 'personal';
-- Expected: 0
