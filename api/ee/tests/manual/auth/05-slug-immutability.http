###
# Organization Slug Immutability Tests
# Tests that organization slug cannot be changed once set
#
# This validates the business rule:
# - Slug can be null (for backward compatibility)
# - Slug can be set once (from null to a value)
# - Slug CANNOT be changed once set (immutable)
###

@baseUrl = http://localhost:8000
@contentType = application/json

# REPLACE WITH ACTUAL VALUES
@organizationId = 00000000-0000-0000-0000-000000000000

###
# Scenario 1: Set slug for organization without slug (Should Succeed)
###

# Step 1: Verify organization has no slug
# SQL: SELECT id, name, slug FROM organizations WHERE id = '<organizationId>';
# Expected: slug IS NULL

# Step 2: Set slug for the first time
# This should SUCCEED
# Note: Replace with your actual organization update endpoint
PATCH {{baseUrl}}/api/organizations/{{organizationId}}
Content-Type: {{contentType}}

{
  "slug": "acme"
}

# Expected Response: 200 OK
# Slug should now be set to "acme"


###
# Scenario 2: Try to change existing slug (Should Fail)
###

# Prerequisites: Organization already has slug="acme"

# Step 1: Try to change slug to different value
# This should FAIL with ValueError
PATCH {{baseUrl}}/api/organizations/{{organizationId}}
Content-Type: {{contentType}}

{
  "slug": "different-slug"
}

# Expected Response: 400 Bad Request or 422 Validation Error
# {
#   "detail": "Organization slug cannot be changed once set. Current slug: 'acme'"
# }


###
# Scenario 3: Update slug to same value (Should Succeed)
###

# Prerequisites: Organization has slug="acme"

# Step 1: Set slug to the same value
# This should SUCCEED (idempotent operation)
PATCH {{baseUrl}}/api/organizations/{{organizationId}}
Content-Type: {{contentType}}

{
  "slug": "acme"
}

# Expected Response: 200 OK
# Slug remains "acme"


###
# Scenario 4: Update other fields without touching slug (Should Succeed)
###

# Prerequisites: Organization has slug="acme"

# Step 1: Update organization name without changing slug
# This should SUCCEED
PATCH {{baseUrl}}/api/organizations/{{organizationId}}
Content-Type: {{contentType}}

{
  "name": "ACME Corporation Updated",
  "description": "New description"
}

# Expected Response: 200 OK
# Name and description updated, slug unchanged


###
# Scenario 5: Try to set slug to null/empty (Should Fail)
###

# Prerequisites: Organization has slug="acme"

# Step 1: Try to clear the slug
# This should FAIL (changing from value to null)
PATCH {{baseUrl}}/api/organizations/{{organizationId}}
Content-Type: {{contentType}}

{
  "slug": null
}

# Expected Response: 400 Bad Request
# Slug should remain "acme"


###
# Verification Queries
###

# Check slug value after operations
# SQL: SELECT id, name, slug FROM organizations WHERE id = '<organizationId>';

# Check slug is unique across organizations
# SQL: SELECT slug, COUNT(*) FROM organizations WHERE slug IS NOT NULL GROUP BY slug HAVING COUNT(*) > 1;
# Expected: No rows (all slugs unique)

# Find organizations without slugs (legacy)
# SQL: SELECT id, name, created_at FROM organizations WHERE slug IS NULL ORDER BY created_at;


###
# Edge Cases
###

# Edge Case 1: Slug with special characters
PATCH {{baseUrl}}/api/organizations/{{organizationId}}
Content-Type: {{contentType}}

{
  "slug": "my-org-2024"
}

# Should succeed if slug validation allows hyphens and numbers


# Edge Case 2: Very long slug
PATCH {{baseUrl}}/api/organizations/{{organizationId}}
Content-Type: {{contentType}}

{
  "slug": "this-is-a-very-long-organization-slug-that-might-exceed-limits"
}

# Should fail if slug has length constraint


# Edge Case 3: Duplicate slug (different organization)
# Prerequisites: Organization A has slug="acme"
# Try to set Organization B's slug to "acme"
# Expected: Database constraint violation (unique constraint)


###
# Test Summary
###

# ✅ Setting slug first time (null → value): ALLOWED
# ✅ Updating slug to same value: ALLOWED
# ❌ Changing slug (value → different value): BLOCKED
# ❌ Clearing slug (value → null): BLOCKED
# ✅ Updating other fields with slug set: ALLOWED
# ❌ Duplicate slugs across orgs: BLOCKED (DB constraint)


###
# Implementation Details
###

# The validation is implemented in:
# - File: vibes/api/oss/src/services/db_manager.py
# - Function: update_organization()
# - Lines: 1416-1423

# Validation Logic:
# if "slug" in values_to_update:
#     new_slug = values_to_update["slug"]
#     if organization.slug is not None and new_slug != organization.slug:
#         raise ValueError(
#             f"Organization slug cannot be changed once set. "
#             f"Current slug: '{organization.slug}'"
#         )

# Database Constraint:
# - UNIQUE constraint on organizations.slug
# - Ensures no two organizations can have the same slug
# - Nullable (allows multiple orgs with slug=NULL)


###
# Migration Reference
###

# Migration: 12d23a8f7dde_add_slug_to_organizations.py
# - Adds slug column (nullable, unique)
# - Creates unique constraint: uq_organizations_slug
# - Creates index: ix_organizations_slug
# - Allows backward compatibility (existing orgs have slug=NULL)
