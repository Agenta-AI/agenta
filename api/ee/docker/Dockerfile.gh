FROM python:3.11-slim-bookworm AS builder

ARG POETRY_VERSION=1.8.4

WORKDIR /app

ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1 \
    POETRY_VIRTUALENVS_CREATE=false \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PATH="/opt/venv/bin:${PATH}"

RUN python -m venv /opt/venv \
    && pip install --upgrade pip \
    && pip install "poetry==${POETRY_VERSION}"

COPY ./pyproject.toml ./poetry.lock* /app/

RUN --mount=type=cache,target=/root/.cache/pip \
    --mount=type=cache,target=/root/.cache/pypoetry \
    poetry install --only main --no-root --no-interaction --no-ansi

COPY ./ee /app/ee/
COPY ./oss /app/oss/
COPY ./entrypoints /app/entrypoints/
COPY ./sd[k] /app/sdk/

RUN if [ -f /app/sdk/pyproject.toml ]; then pip install --editable /app/sdk; fi


FROM python:3.11-slim-bookworm AS runtime

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=0.0.0

WORKDIR /app

LABEL org.opencontainers.image.title="agenta-api-ee" \
    org.opencontainers.image.description="Agenta API EE GH runtime image" \
    org.opencontainers.image.version="${VERSION}" \
    org.opencontainers.image.revision="${VCS_REF}" \
    org.opencontainers.image.created="${BUILD_DATE}"

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app:/app/sdk \
    PATH="/opt/venv/bin:${PATH}"

RUN apt-get update && \
    apt-get install -y --no-install-recommends curl cron gnupg2 lsb-release && \
    echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list && \
    curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | \
    gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg && \
    apt-get update && \
    apt-get install -y --no-install-recommends postgresql-client-17 && \
    rm -rf /var/lib/apt/lists/*

COPY --from=builder /opt/venv /opt/venv
COPY --from=builder /app/ee /app/ee
COPY --from=builder /app/oss /app/oss
COPY --from=builder /app/entrypoints /app/entrypoints
COPY --from=builder /app/sdk /app/sdk

COPY --chmod=755 ./oss/src/crons/queries.sh /queries.sh
COPY --chmod=644 ./oss/src/crons/queries.txt /etc/cron.d/queries-cron
COPY --chmod=755 ./ee/src/crons/meters.sh /meters.sh
COPY --chmod=644 ./ee/src/crons/meters.txt /etc/cron.d/meters-cron
COPY --chmod=755 ./ee/src/crons/spans.sh /spans.sh
COPY --chmod=644 ./ee/src/crons/spans.txt /etc/cron.d/spans-cron

RUN set -eux; \
    for cron_file in /etc/cron.d/queries-cron /etc/cron.d/meters-cron /etc/cron.d/spans-cron; do \
        sed -i -e '$a\' "${cron_file}"; \
    done

EXPOSE 8000
