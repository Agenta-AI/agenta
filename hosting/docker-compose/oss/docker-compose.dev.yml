name: agenta-oss-dev

services:
    .api:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-api:latest
        build:
            context: ../../../api
            dockerfile: oss/docker/Dockerfile.dev
        # === EXECUTION ============================================ #
        command: ["true"]

    .web:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-web:latest
        build:
            context: ../../../web
            dockerfile: oss/docker/Dockerfile.dev
        # === EXECUTION ============================================ #
        command: ["true"]

    .services:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-services:latest
        build:
            context: ../../../services
            dockerfile: oss/docker/Dockerfile.dev
        # === EXECUTION ============================================ #
        command: ["true"]

    web:
        # === ACTIVATION =========================================== #
        profiles:
            - with-web
        # === IMAGE ================================================ #
        image: agenta-oss-dev-web:latest
        # === EXECUTION ============================================ #
        command: sh -c "pnpm dev-oss"
        # === STORAGE ============================================== #
        volumes:
            #
            #
            - ../../../web/oss/src:/app/oss/src
            - ../../../web/oss/public:/app/oss/public
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            DOCKER_NETWORK_MODE: ${DOCKER_NETWORK_MODE:-bridge}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        # === LABELS =============================================== #
        labels:
            - "traefik.http.routers.agenta-web.rule=PathPrefix(`/`)"
            - "traefik.http.routers.agenta-web.entrypoints=web"
            - "traefik.http.services.agenta-web.loadbalancer.server.port=3000"
        # === LIFECYCLE ============================================ #
        restart: always

    api:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-api:latest
        # === EXECUTION ============================================ #
        command:
            [
                "uvicorn",
                "entrypoints.routers:app",
                "--host",
                "0.0.0.0",
                "--port",
                "8000",
                "--reload",
                "--root-path",
                "/api",
            ]
        # === STORAGE ============================================== #
        volumes:
            #
            - ../../../api/oss:/app/oss
            - ../../../api/entrypoints:/app/entrypoints
            - ../../../sdk:/sdk
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            DOCKER_NETWORK_MODE: ${DOCKER_NETWORK_MODE:-bridge}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        extra_hosts:
            - "host.docker.internal:host-gateway"
        # === ORCHESTRATION ======================================== #
        depends_on:
            postgres:
                condition: service_healthy
            alembic:
                condition: service_completed_successfully
            supertokens:
                condition: service_healthy
            redis-volatile:
                condition: service_healthy
            redis-durable:
                condition: service_healthy
        # === LABELS =============================================== #
        labels:
            - "traefik.http.routers.api.rule=PathPrefix(`/api/`)"
            - "traefik.http.routers.api.entrypoints=web"
            - "traefik.http.middlewares.api-strip.stripprefix.prefixes=/api"
            - "traefik.http.middlewares.api-strip.stripprefix.forceslash=true"
            - "traefik.http.routers.api.middlewares=api-strip"
            - "traefik.http.services.api.loadbalancer.server.port=8000"
            - "traefik.http.routers.api.service=api"
        # === LIFECYCLE ============================================ #
        restart: always

    worker-evaluations:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-api:latest
        # === EXECUTION ============================================ #
        command: >
            watchmedo auto-restart --directory=/app/ --pattern=*.py --recursive --
            python -m entrypoints.worker_evaluations
        # === STORAGE ============================================== #
        volumes:
            #
            - ../../../api/oss:/app/oss
            - ../../../api/entrypoints:/app/entrypoints
            - ../../../sdk:/sdk
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            DOCKER_NETWORK_MODE: ${DOCKER_NETWORK_MODE:-bridge}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        extra_hosts:
            - "host.docker.internal:host-gateway"
        # === ORCHESTRATION ======================================== #
        depends_on:
            postgres:
                condition: service_healthy
            alembic:
                condition: service_completed_successfully
            redis-volatile:
                condition: service_healthy
            redis-durable:
                condition: service_healthy
        # === LIFECYCLE ============================================ #
        restart: always

    worker-tracing:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-api:latest
        # === EXECUTION ============================================ #
        command: >
            watchmedo auto-restart --directory=/app/ --pattern=*.py --recursive --
            python -m entrypoints.worker_tracing
        # === STORAGE ============================================== #
        volumes:
            #
            - ../../../api/oss:/app/oss
            - ../../../api/entrypoints:/app/entrypoints
            - ../../../sdk:/sdk
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            DOCKER_NETWORK_MODE: ${DOCKER_NETWORK_MODE:-bridge}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        extra_hosts:
            - "host.docker.internal:host-gateway"
        # === ORCHESTRATION ======================================== #
        depends_on:
            postgres:
                condition: service_healthy
            alembic:
                condition: service_completed_successfully
            redis-volatile:
                condition: service_healthy
            redis-durable:
                condition: service_healthy
        # === LIFECYCLE ============================================ #
        restart: always

    cron:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-api:latest
        # === EXECUTION ============================================ #
        command: cron -f
        # === STORAGE ============================================== #
        volumes:
            #
            - ../../../api/oss/src/crons/queries.sh:/queries.sh
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            DOCKER_NETWORK_MODE: ${DOCKER_NETWORK_MODE:-bridge}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        extra_hosts:
            - "host.docker.internal:host-gateway"
        # === ORCHESTRATION ======================================== #
        depends_on:
            - postgres
            - api
        # === LIFECYCLE ============================================ #
        restart: always

    alembic:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-api:latest
        # === EXECUTION ============================================ #
        command: sh -c "python -m oss.databases.postgres.migrations.runner"
        # === STORAGE ============================================== #
        volumes:
            #
            - ../../../api/oss:/app/oss
            - ../../../api/entrypoints:/app/entrypoints
            - ../../../sdk:/sdk
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            DOCKER_NETWORK_MODE: ${DOCKER_NETWORK_MODE:-bridge}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        # === ORCHESTRATION ======================================== #
        depends_on:
            postgres:
                condition: service_healthy

    services:
        # === IMAGE ================================================ #
        image: agenta-oss-dev-services:latest
        # === EXECUTION ============================================ #
        command:
            [
                "uvicorn",
                "entrypoints.main:app",
                "--host",
                "0.0.0.0",
                "--port",
                "80",
                "--reload",
                "--root-path",
                "/services",
            ]
        # === STORAGE ============================================== #
        volumes:
            - ../../../services:/app
            - ../../../sdk:/sdk
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            DOCKER_NETWORK_MODE: ${DOCKER_NETWORK_MODE:-bridge}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        extra_hosts:
            - "host.docker.internal:host-gateway"
        # === LABELS =============================================== #
        labels:
            - "traefik.http.routers.services.rule=PathPrefix(`/services/`)"
            - "traefik.http.routers.services.entrypoints=web"
            - "traefik.http.middlewares.services-strip.stripprefix.prefixes=/services"
            - "traefik.http.middlewares.services-strip.stripprefix.forceslash=true"
            - "traefik.http.routers.services.middlewares=services-strip"
            - "traefik.http.services.services.loadbalancer.server.port=80"
            - "traefik.http.routers.services.service=services"
        # === LIFECYCLE ============================================ #
        restart: always

    postgres:
        # === IMAGE ================================================ #
        image: postgres:16
        # === STORAGE ============================================== #
        volumes:
            - postgres-data:/var/lib/postgresql/data/
            - ../../../api/oss/databases/postgres/init-db-oss.sql:/docker-entrypoint-initdb.d/init-db.sql
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-username}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        ports:
            - "${POSTGRES_PORT:-5432}:5432"
        # === LIFECYCLE ============================================ #
        restart: always
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U username -d agenta_oss_core"]
            interval: 10s
            timeout: 5s
            retries: 5

    redis-volatile:
        # === IMAGE ================================================ #
        image: redis:8
        # === EXECUTION ============================================ #
        command: >
            redis-server
            --appendonly no
            --save ""
            --maxmemory 512mb
            --maxmemory-policy volatile-lru
            --port 6379
        # === STORAGE ============================================== #
        volumes:
            - redis-volatile-data:/data
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        # === LIFECYCLE ============================================ #
        restart: always
        healthcheck:
            test: ["CMD", "redis-cli", "-p", "6379", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    redis-durable:
        # === IMAGE ================================================ #
        image: redis:8
        # === EXECUTION ============================================ #
        command: >
            redis-server
            --appendonly yes
            --appendfsync no
            --save ""
            --maxmemory 512mb
            --maxmemory-policy noeviction
            --port 6381
        # === STORAGE ============================================== #
        volumes:
            - redis-durable-data:/data
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        # === LIFECYCLE ============================================ #
        restart: always
        healthcheck:
            test: ["CMD", "redis-cli", "-p", "6381", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    traefik:
        # === IMAGE ================================================ #
        image: traefik:2
        # === EXECUTION ============================================ #
        command:
            - --api.dashboard=true
            - --api.insecure=true
            - --providers.docker
            - --providers.docker.constraints=Label(`com.docker.compose.project`,`${COMPOSE_PROJECT_NAME:-agenta-oss-dev}`)
            - --entrypoints.web.address=:80
            - --ping=true
            - --accesslog=true
        # === STORAGE ============================================== #
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        ports:
            - "${TRAEFIK_PORT:-80}:80"
            - "${TRAEFIK_UI_PORT:-8080}:8080"
        # === LIFECYCLE ============================================ #
        restart: always
        healthcheck:
            test: ["CMD", "traefik", "healthcheck", "--ping"]
            interval: 10s
            timeout: 5s
            retries: 3
            start_period: 10s

    supertokens:
        # === IMAGE ================================================ #
        image: registry.supertokens.io/supertokens/supertokens-postgresql
        # === CONFIGURATION ======================================== #
        env_file:
            - ${ENV_FILE:-./.env.oss.dev}
        environment:
            POSTGRESQL_CONNECTION_URI: ${POSTGRES_URI_SUPERTOKENS:-postgresql://username:password@postgres:5432/agenta_oss_supertokens}
        # === NETWORK ============================================== #
        networks:
            - agenta-network
        # === ORCHESTRATION ======================================== #
        depends_on:
            postgres:
                condition: service_healthy
            alembic:
                condition: service_completed_successfully
        # === LIFECYCLE ============================================ #
        restart: always
        healthcheck:
            test: >
                bash -c 'exec 3<>/dev/tcp/127.0.0.1/3567 && echo -e "GET /hello HTTP/1.1\r\nhost: 127.0.0.1:3567\r\nConnection: close\r\n\r\n" >&3 && cat <&3 | grep "Hello"'
            interval: 10s
            timeout: 5s
            retries: 5

    #
    #
    #
    #
    #
    #
    #
    #
    #
    #
    #
    #
    #
    #
    #
    #
    #

networks:
    agenta-network:

volumes:
    postgres-data:
    redis-volatile-data:
    redis-durable-data:
    nextjs_cache:
