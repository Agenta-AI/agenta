name: agenta-ee-dev

services:
    # Build services - keep for caching but not strictly needed
    .api:
        image: agenta-ee-dev-api:latest
        build:
            context: ../../../api
            dockerfile: ee/docker/Dockerfile.dev
        command: ["true"]

    .web:
        image: agenta-ee-dev-web:latest
        build:
            context: ../../../web
            dockerfile: ee/docker/Dockerfile.dev
        command: ["true"]

    web:
        profiles:
            - with-web

        image: agenta-ee-dev-web:latest

        volumes:
            - ../../../web/ee/src:/app/ee/src
            - ../../../web/ee/public:/app/ee/public
            - ../../../web/oss/src:/app/oss/src
            - ../../../web/oss/public:/app/oss/public
            
        env_file:
            - ${ENV_FILE:-./.env.ee.dev}

        ports:
            - "3000:3000"
        
        restart: always
        
        networks:
            - agenta-network
            
        labels:
            - "traefik.http.routers.agenta-web.rule=PathPrefix(`/`)"
            - "traefik.http.routers.agenta-web.entrypoints=web"
            - "traefik.http.services.agenta-web.loadbalancer.server.port=3000"

        command: sh -c "pnpm dev-ee"

    api:
        image: agenta-ee-dev-api:latest

        volumes:
            - ../../../api:/app
            - ../../../sdk:/sdk

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}

        labels:
            - "traefik.http.routers.api.rule=PathPrefix(`/api/`)"
            - "traefik.http.routers.api.entrypoints=web"
            - "traefik.http.middlewares.api-strip.stripprefix.prefixes=/api"
            - "traefik.http.middlewares.api-strip.stripprefix.forceslash=true"
            - "traefik.http.routers.api.middlewares=api-strip"
            - "traefik.http.services.api.loadbalancer.server.port=8000"
            - "traefik.http.routers.api.service=api"

        restart: always
        
        networks:
            - agenta-network
            
        extra_hosts:
            - "host.docker.internal:host-gateway"

        command:
            [
                "uvicorn",
                "entrypoint:app",
                "--host",
                "0.0.0.0",
                "--port",
                "8000",
                "--reload",
                "--root-path",
                "/api",
            ]

        depends_on:
            postgres:
                condition: service_healthy
            alembic:
                condition: service_completed_successfully
            supertokens:
                condition: service_healthy

    worker:
        image: agenta-ee-dev-api:latest

        volumes:
            - ../../../api:/app
            - ../../../sdk:/sdk

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}
        
        depends_on:
            - postgres
            - rabbitmq
            - redis

        extra_hosts:
            - "host.docker.internal:host-gateway"
        
        restart: always
        
        networks:
            - agenta-network

        command: >
            watchmedo auto-restart --directory=/app/ --pattern=*.py --recursive -- 
            celery -A entrypoint.celery_app worker --concurrency=1 --max-tasks-per-child=1 --prefetch-multiplier=1 --loglevel=DEBUG

    cron:
        image: agenta-ee-dev-api:latest

        volumes:
            - ../../../api/ee/src/crons/meters.sh:/meters.sh
            - ../../../api/oss/src/crons/queries.sh:/queries.sh

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}
        
        depends_on:
            - postgres
            - api

        extra_hosts:
            - "host.docker.internal:host-gateway"
        
        restart: always
        
        networks:
            - agenta-network

        command: cron -f

    alembic:
        image: agenta-ee-dev-api:latest

        volumes:
            - ../../../api:/app
            - ../../../sdk:/sdk

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}

        depends_on:
            postgres:
                condition: service_healthy
                
        networks:
            - agenta-network

        command: sh -c "python -m ee.databases.postgres.migrations.runner"

    completion:
        build: 
            context: ../../../services/completion
            dockerfile: ee/docker/Dockerfile.dev

        volumes:
            - ../../../services/completion:/app
            - ../../../sdk:/sdk

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}
            
        extra_hosts:
            - "host.docker.internal:host-gateway"
            
        labels:
            - "traefik.http.routers.completion.rule=PathPrefix(`/services/completion/`)"
            - "traefik.http.routers.completion.entrypoints=web"
            - "traefik.http.middlewares.completion-strip.stripprefix.prefixes=/services/completion"
            - "traefik.http.middlewares.completion-strip.stripprefix.forceslash=true"
            - "traefik.http.routers.completion.middlewares=completion-strip"
            - "traefik.http.services.completion.loadbalancer.server.port=80"
            - "traefik.http.routers.completion.service=completion"
        
        restart: always
        
        networks:
            - agenta-network
        
        command: ["python", "oss/src/main.py"]

    chat:
        build: 
            context: ../../../services/chat
            dockerfile: ee/docker/Dockerfile.dev

        volumes:
            - ../../../services/chat:/app
            - ../../../sdk:/sdk

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}
            
        extra_hosts:
            - "host.docker.internal:host-gateway"
            
        labels:
            - "traefik.http.routers.chat.rule=PathPrefix(`/services/chat/`)"
            - "traefik.http.routers.chat.entrypoints=web"
            - "traefik.http.middlewares.chat-strip.stripprefix.prefixes=/services/chat"
            - "traefik.http.middlewares.chat-strip.stripprefix.forceslash=true"
            - "traefik.http.routers.chat.middlewares=chat-strip"
            - "traefik.http.services.chat.loadbalancer.server.port=80"
            - "traefik.http.routers.chat.service=chat"
        
        restart: always
        
        networks:
            - agenta-network

        command: ["python", "oss/src/main.py"]

    postgres:
        image: postgres:16.2

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}
            
        ports:
            - "5432:5432"

        restart: always

        networks:
            - agenta-network
            
        volumes:
            - postgres-data:/var/lib/postgresql/data/
            - ../../../api/ee/databases/postgres/init-db-ee.sql:/docker-entrypoint-initdb.d/init-db.sql
            
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U username -d agenta_ee_core"]
            interval: 10s
            timeout: 5s
            retries: 5

    clickhouse:
        image: clickhouse/clickhouse-server:24.3

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}

        environment:
            CLICKHOUSE_DB: ${CLICKHOUSE_DATABASE:-agenta_ee_tracing}
            CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
            CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
            CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1

        ports:
            - "8123:8123"  # HTTP interface
            - "8900:9000"  # Native protocol (host:container - using 8900 to avoid conflict)

        restart: always

        networks:
            - agenta-network
        volumes:
            - clickhouse-data:/var/lib/clickhouse

        ulimits:
            nofile:
                soft: 262144
                hard: 262144

        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    rabbitmq:
        image: rabbitmq:3-management
        
        ports:
            - "${RABBITMQ_PORT:-5672}:5672"
            - "${RABBITMQ_UI_PORT:-15672}:15672"
            
        volumes:
            - rabbitmq-data:/var/lib/rabbitmq
            
        env_file:
            - ${ENV_FILE:-./.env.ee.dev}
        
        restart: always
        
        networks:
            - agenta-network

    redis:
        image: redis:latest

        restart: always
        
        networks:
            - agenta-network
            
        volumes:
            - redis-data:/data

    cache:
        image: redis:latest

        command: >
            redis-server
            --port 6378
            --appendonly no
            --appendfsync no
            --save ""
            --maxmemory 128mb
            --maxmemory-policy allkeys-lru

        ports:
            - "6378:6378"

        volumes:
            - cache-data:/data

        restart: always
        
        networks:
            - agenta-network

        labels:
            - "traefik.enable=false"

        healthcheck:
            test: ["CMD", "redis-cli", "-p", "6378", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s

    traefik:
        image: traefik:v2.10
        
        command: 
            - --api.dashboard=true
            - --api.insecure=true
            - --providers.docker
            - --entrypoints.web.address=:80
            - --ping=true
            - --accesslog=true  # Enable access logs for debugging
        
        ports:
            - "80:80"      # ALB forwards to this port
            - "8080:8080"  # Dashboard (optional, can be internal only)
        
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        
        networks:
            - agenta-network
        
        restart: always
        
        healthcheck:
            test: ["CMD", "traefik", "healthcheck", "--ping"]
            interval: 10s
            timeout: 5s
            retries: 3
            start_period: 10s

    supertokens:
        image: registry.supertokens.io/supertokens/supertokens-postgresql

        depends_on:
            postgres:
                condition: service_healthy
            alembic:
                condition: service_completed_successfully

        ports:
            - "3567:3567"

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}

        environment:
            POSTGRESQL_CONNECTION_URI: ${POSTGRES_URI_SUPERTOKENS}

        restart: always
        
        networks:
            - agenta-network
            
        healthcheck:
            test: >
                bash -c 'exec 3<>/dev/tcp/127.0.0.1/3567 && echo -e "GET /hello HTTP/1.1\r\nhost: 127.0.0.1:3567\r\nConnection: close\r\n\r\n" >&3 && cat <&3 | grep "Hello"'
            interval: 10s
            timeout: 5s
            retries: 5

    stripe:
        image: stripe/stripe-cli:latest

        command: [
            listen,
            --forward-to,
            http://api:8000/billing/stripe/events/,
            --events,
            "customer.subscription.created,customer.subscription.deleted,invoice.updated,invoice.upcoming,invoice.payment_failed,invoice.payment_succeeded"
        ]

        env_file:
            - ${ENV_FILE:-./.env.ee.dev}

        restart: always
        
        networks:
            - agenta-network

networks:
    agenta-network:

volumes:
    postgres-data:
    clickhouse-data:
    rabbitmq-data:
    redis-data:
    cache-data:
    nextjs_cache:
