---
title: "Run LLM Evaluations with SDK"
sidebar_label: "Evaluate with SDK"
description: Learn how to run LLM app evaluations programmatically using the Agenta SDK. This guide covers creating test sets, configuring evaluators, running evaluations, and retrieving results.
---

```mdx-code-block
import GoogleColabButton from "@site/src/components/GoogleColabButton";
```

In this cookbook we will show how to interact with evaluation in agenta programatically. Either using the SDK (or the raw API).

We will do the following:

- Create a test set
- Create and configure an evaluator
- Run an evaluation
- Retrieve the results of evaluations

We assume that you have already created an LLM application and variants in agenta.

<GoogleColabButton notebookPath="examples/jupyter/evaluations_with_sdk.ipynb">
  Open in Google Colaboratory
</GoogleColabButton>
### Architectural Overview:

In this scenario, evaluations are executed on the Agenta backend. Specifically, Agenta invokes the LLM application for each row in the test set and subsequently processes the output using the designated evaluator.
This operation is managed through TaskIQ tasks. The interactions with the LLM application are asynchronous, batched, and include retry mechanisms. Additionally, the batching configuration can be adjusted to avoid exceeding the rate limits imposed by the LLM provider.

## Setup

```python
! pip install -U agenta
```

## Configuration Setup

```python
# Assuming an application has already been created through the user interface, you will need to obtain the application ID.
# In this example we will use the default template single_prompt which has the prompt "Determine the capital of {country}"

# You can find the application ID in the URL. For example, in the URL https://cloud.agenta.ai/apps/666dde95962bbaffdb0072b5/playground?variant=app.default, the application ID is `666dde95962bbaffdb0072b5`.
import agenta as ag

app_id = "667d8cfad1812781f7e375d9"

# You can create the API key under the settings page. If you are using the OSS version, you should keep this as an empty string
api_key = "EUqJGOUu.xxxx"

# Host.
host = "https://cloud.agenta.ai"

# Initialize the SDK
ag.init(host=host, api_key=api_key)
```

## Define the application

```python
@ag.application(
    slug="capital_finder",
    name="Capital Finder",
)
async def capital_finder(country: str):
    capitals = {
        "Germany": "Berlin",
        "France": "Paris",
    }
    return capitals.get(country, "Unknown")
```

## Create a test set

```python
import asyncio
import agenta as ag

# Assumes `ag.init(...)` has already been called.

csvdata = [
    {"country": "France", "capital": "Paris"},
    {"country": "Germany", "capital": "Paris"},
]

async def main():
    # Create a testset (returns a TestsetRevision)
    created = await ag.testsets.acreate(name="test set", data=csvdata)
    testset_id = created.testset_id or created.id

    # Update the testset data
    await ag.testsets.aedit(
        testset_id=testset_id,
        name="test set",
        data=[
            {"country": "France", "capital": "Paris"},
            {"country": "Germany", "capital": "Berlin"},
        ],
    )

    # Fetch the latest revision after editing
    updated = await ag.testsets.aretrieve(testset_id=testset_id)
    return updated

updated = asyncio.run(main())
print(f"Latest revision ID: {updated.id}")
```

# Create evaluators

```python
@ag.evaluator(
    slug="capital_exact_match",
    name="Capital Exact Match",
)
async def exact_match(capital: str, outputs: str):
    return {
        "score": 1.0 if outputs == capital else 0.0,
        "success": outputs == capital,
    }

@ag.evaluator(
    slug="capital_letter_match",
    name="Capital Letter Match",
)
async def letter_match(outputs: str):
    is_capitalized = bool(outputs) and outputs[0].isupper()
    return {
        "score": 1.0 if is_capitalized else 0.0,
        "success": is_capitalized,
    }
```

# Run an evaluation

```python
import asyncio
from agenta.sdk.evaluations import aevaluate

async def main():
    result = await aevaluate(
        name="Capital evaluation",
        testsets=[updated.id],
        applications=[capital_finder],
        evaluators=[exact_match, letter_match],
    )

    print(result)
    return result

result = asyncio.run(main())
```
