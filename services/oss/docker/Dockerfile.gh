FROM python:3.11-slim-bookworm AS builder

ARG POETRY_VERSION=1.8.4

WORKDIR /app

ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Install poetry system-level (outside venv) â€” only used for export
RUN pip install "poetry==${POETRY_VERSION}" "poetry-plugin-export"

COPY ./pyproject.toml ./poetry.lock* /app/

# Create clean venv and install only app deps into it
RUN python -m venv /opt/venv \
    && . /opt/venv/bin/activate \
    && poetry export --only main --without-hashes --format requirements.txt --output /tmp/requirements.txt \
    && pip install --no-cache-dir -r /tmp/requirements.txt \
    && rm -f /tmp/requirements.txt \
    && pip uninstall -y pip setuptools 2>/dev/null; true \
    && find /opt/venv -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null; true

COPY ./oss /app/oss/
COPY ./entrypoints /app/entrypoints/
RUN mkdir -p /app/sdk
COPY ./sd[k] /app/sdk/


FROM python:3.11-slim-bookworm AS runtime

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=0.0.0

WORKDIR /app

LABEL org.opencontainers.image.title="agenta-services" \
    org.opencontainers.image.description="Agenta Services GH runtime image" \
    org.opencontainers.image.version="${VERSION}" \
    org.opencontainers.image.revision="${VCS_REF}" \
    org.opencontainers.image.created="${BUILD_DATE}"

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app:/app/sdk \
    PATH="/opt/venv/bin:${PATH}"

COPY --from=builder /opt/venv /opt/venv
COPY --from=builder /app/oss /app/oss
COPY --from=builder /app/entrypoints /app/entrypoints
COPY --from=builder /app/sdk /app/sdk

EXPOSE 80
