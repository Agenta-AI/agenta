FROM python:3.11-slim-bookworm AS builder

ARG POETRY_VERSION=1.8.4

WORKDIR /app

ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1 \
    POETRY_VIRTUALENVS_CREATE=false \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PATH="/opt/venv/bin:${PATH}"

RUN python -m venv /opt/venv \
    && pip install --upgrade pip \
    && pip install "poetry==${POETRY_VERSION}"

COPY ./pyproject.toml ./poetry.lock* /app/

RUN --mount=type=cache,target=/root/.cache/pip \
    --mount=type=cache,target=/root/.cache/pypoetry \
    poetry export --only main --without-hashes --format requirements.txt --output /tmp/requirements.txt \
    && pip install --no-cache-dir -r /tmp/requirements.txt \
    && rm -f /tmp/requirements.txt

COPY ./oss /app/oss/
COPY ./entrypoints /app/entrypoints/
RUN mkdir -p /app/sdk
COPY ./sd[k] /app/sdk/


FROM python:3.11-slim-bookworm AS runtime

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=0.0.0

WORKDIR /app

LABEL org.opencontainers.image.title="agenta-services-ee" \
    org.opencontainers.image.description="Agenta Services EE GH runtime image" \
    org.opencontainers.image.version="${VERSION}" \
    org.opencontainers.image.revision="${VCS_REF}" \
    org.opencontainers.image.created="${BUILD_DATE}"

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app:/app/sdk \
    PATH="/opt/venv/bin:${PATH}"

COPY --from=builder /opt/venv /opt/venv
COPY --from=builder /app/oss /app/oss
COPY --from=builder /app/entrypoints /app/entrypoints
COPY --from=builder /app/sdk /app/sdk

EXPOSE 80
